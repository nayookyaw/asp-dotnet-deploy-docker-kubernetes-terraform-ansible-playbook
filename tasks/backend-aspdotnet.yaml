# =========================================================
# COPY Docker tar file from local to remote/server
# =========================================================
---
- name: Load shared variables
  include_vars:
    file: ../vars/main.yaml

- name: Load shared variables
  include_vars:
    file: ../vars/main.yaml

- name: Ensure folder created
  file:
    path: "{{backend_remote_path}}"
    state: directory
  become: true

- name: Ensure folder created
  file:
    path: "{{ backend_remote_path }}/logs"
    state: directory
  become: true

- name: Ensure backend file copied
  copy:
    src: data/backend/
    dest: "{{backend_remote_path}}/"
  become: true

# =========================================================
# Load local Docker image tar file into Docker + kind
# =========================================================
- name: Load Docker image from tar file
  shell: docker load -i "{{ backend_remote_path }}/{{ image_tar_file }}"

- name: Load Docker image into kind cluster
  shell: kind load docker-image "{{ image_name }}" --name "{{ kind_cluster_name }}"

# ================================
# Copy Kubernetes YAMLs & apply
# ================================
- name: Create k8s manifests directory on Ubuntu
  file:
    path: "{{ k8s_remote_path }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"
  become: true

- name: Render namespace manifest
  template:
    src: "../k8s/namespace.yaml.j2"
    dest: "{{ k8s_remote_path }}/namespace.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  become: true

- name: Render ASP.NET Core deployment + service
  template:
    src: "../k8s/myapp-web.yaml.j2"
    dest: "{{ k8s_remote_path }}/myapp-web.yaml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  become: true

- name: Apply namespace
  shell: kubectl apply -f namespace.yaml
  args:
    chdir: "{{ k8s_remote_path }}"

- name: Apply ASP.NET Core deployment + service
  shell: kubectl apply -f myapp-web.yaml
  args:
    chdir: "{{ k8s_remote_path }}"

- name: Render ingress myapp web template
  template:
    src: ../k8s/myapp-web-ingress.yaml.j2
    dest: "{{ k8s_remote_path }}/myapp-ingress.yaml"
  become: true

- name: Restart deployment to pick up new image
  shell: kubectl rollout restart deployment/myapp-web -n {{ k8s_namespace }}
  args:
    chdir: "{{ k8s_remote_path }}"

- name: Apply ingress
  shell: kubectl apply -f "{{ k8s_remote_path }}/myapp-ingress.yaml"